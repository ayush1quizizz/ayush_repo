WITH src AS (
SELECT
user_id,
game_id,
game_mode,
created_at,
ARRAY_TO_STRING(comments, '\n') AS comments_text
FROM `quizizz-org.raw.feedback`
WHERE event_name = 'ft_pres_survey'
AND game_id IS NOT NULL
)

,final AS(
SELECT
DISTINCT
user_id,
A.created_at,
-- Prefer structured game_mode; fallback to comments
COALESCE(
game_mode,
TRIM(REGEXP_EXTRACT(comments_text, r'(?i)Game mode-\s*([^\n|]+)'))
) AS game_mode,

-- Purpose: first try to extract with "Purpose-", else take second line
COALESCE(
TRIM(REGEXP_EXTRACT(comments_text, r'(?i)Purpose-\s*([^\n|]+)')),
SPLIT(comments_text, '\n')[SAFE_OFFSET(1)] -- second line if no "Purpose-" keyword
) AS purpose,

SAFE_CAST(REGEXP_EXTRACT(comments_text, r'(?i)Student Engagement:\s*(\d+)') AS INT64)
AS student_engagement_rating,

SAFE_CAST(REGEXP_EXTRACT(comments_text, r'(?i)tech issues:\s*(\d+)') AS INT64)
AS tech_issues_rating,

SAFE_CAST(REGEXP_EXTRACT(comments_text, r'(?i)(?:Resource\s+)?Quality:\s*(\d+)') AS INT64)
AS resource_quality_rating,

((SAFE_CAST(REGEXP_EXTRACT(comments_text, r'(?i)Student Engagement:\s*(\d+)') AS INT64)+SAFE_CAST(REGEXP_EXTRACT(comments_text, r'(?i)tech issues:\s*(\d+)') AS INT64)+SAFE_CAST(REGEXP_EXTRACT(comments_text, r'(?i)(?:Resource\s+)?Quality:\s*(\d+)') AS INT64))*(1.0)/3)
AS avg_rating,

TRIM(REGEXP_EXTRACT(comments_text, r'(?i)User suggestion-\s*([^\n|]+)')) AS user_suggestion,

comments_text,
game_type,
quiz_type,
B.quiz_id

FROM src A
INNER JOIN clean.game B
ON A.game_id = B.game_id
AND DATE(B.created_at) >= '2025-08-01'
GROUP BY ALL
ORDER BY created_at
)
select date_trunc(date(created_at),week) as dt,
       game_mode, 
       round(avg(avg_rating),1) as avg_rating
from final 
group by 1,2
order by 1,2 desc





















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































